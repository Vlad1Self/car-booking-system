# Car Booking System API

## Основные возможности

*   Регистрация и авторизация через Sanctum с автоматической регистрацией имени устройства.
*   Доступ к автомобилям строго ограничен категориями комфорта, привязанными к должности сотрудника.
*   Автоматическая проверка пересечений по времени в существующих бронированиях автомобиля и водителя.
*   Фильтрация по моделям, категориям комфорта, водителям и временным интервалам.
*   Единый формат JSON-ответов для всех эндпоинтов и системных исключений.

## Установка

1. **Клонируйте репозиторий:**
   ```bash
   git clone https://github.com/vlad1self/car-booking-system.git
   cd car-booking-system
   ```

2. **Установите зависимости:**
   ```bash
   composer install
   ```

3. **Настройте окружение:**
   ```bash
   cp .env.example .env
   php artisan key:generate
   ```

4. **Запустите миграции и сидеры:**
   ```bash
   php artisan migrate --seed
   ```

5. **Запустите локальный сервер:**
   ```bash
   php artisan serve
   ```


## Сценарий работы (Инструкция по проверке)

Для быстрой проверки системы используйте следующий сценарий:

### 1. Авторизация
Войдите под тестовым пользователем (Менеджер), созданным сидером:
*   **Метод**: `POST /api/login`
*   **Тело**:
    ```json
    {
        "email": "manager@test.com",
        "password": "password"
    }
    ```
*   **Результат**: Сохраните полученный `token` для последующих запросов.

### 2. Поиск доступных автомобилей
Запросите список машин на будущую дату. Помните, что Менеджеру доступны категории "Бизнес" и "Комфорт", но **запрещена** категория "Премиум" (S-Class).
*   **Метод**: `GET /api/available-cars`
*   **Параметры**: `start_time=2027-01-01 10:00:00&end_time=2027-01-01 14:00:00`
*   **Фильтрация**: Чтобы сузить поиск, добавьте ID модели или водителя (можно взять из ответа выше).
    *   Пример с фильтром по модели: `...&car_model_id=3` (Toyota Camry).

### 3. Выход из системы
Вы можете завершить текущую сессию или сбросить все активные токены.
*   **Метод**: `POST /api/logout`
*   **Тело (опционально)**:
    ```json
    {
        "all_devices": true
    }
    ```
    *(Если `true` — пользователь будет разлогинен на всех устройствах одновременно)*.


## Основные API Эндпоинты

Абсолютно все ответы API (как успешные, так и ошибки) возвращаются в едином стандартизированном формате:

```json
{
    "data": [],
    "meta": [], 
    "status": {
        "code": 200,    
        "message": "",  
        "description": "" 
    }
}
```

### Аутентификация
*   `POST /api/register` — Регистрация нового сотрудника.
*   `POST /api/login` — Авторизация и получение токена.
*   `POST /api/logout` — Выход из системы.

### Автомобили
*   `GET /api/available-cars` — Поиск доступных машин.
    *   **Параметры**: `start_time`, `end_time` (обязательные), `car_model_id`, `driver_id`, `comfort_category_id` (опциональные фильтры).
    *   **Логика**: Машина не отобразится, если автомобиль или водитель заняты в указанный период, а также если категория комфорта авто превышает лимиты, разрешенные для должности пользователя.

---

### Ограничение частоты запросов (Rate Limiting)
1.  **Auth (5 зап/мин)**: Защита от brute-force атак на эндпоинты `/login` и `/register`.
2.  **API (60 зап/мин)**: Общее ограничение для авторизованных пользователей.

### Обработка ошибок
Система автоматически перехватывает все исключения и возвращает их в унифицированном JSON-формате с соответствующими статус-кодами:

*   `400` — Некорректный запрос
*   `401` — Не авторизован
*   `403` — Доступ запрещён (нехватка прав должности)
*   `404` — Ресурс не найден
*   `405` — Метод не разрешён
*   `422` — Ошибка валидации (подробности передаются в ключе `data`)
*   `429` — Слишком много запросов (Rate Limit)
*   `500` — Внутренняя ошибка сервера
*   `503` — Сервис недоступен

## Тестирование

Проект покрыт автоматическими тестами (Feature & Unit):
```bash
php artisan test
```
*   **Feature-тесты**: Проверка сценариев регистрации, логики бронирования и фильтрации.
*   **Unit-тесты**: Изолированная проверка вспомогательных классов и сервисов.